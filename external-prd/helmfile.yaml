repositories:
  - name: incubator
    url: http://storage.googleapis.com/kubernetes-charts-incubator
  - name: uswitch
    url: https://uswitch.github.io/kiam-helm-charts/charts/
  - name: h3poteto-stable
    url: https://h3poteto.github.io/charts/stable

releases:
  - name: alb-ingress-controller
    namespace: kube-system
    chart: incubator/aws-alb-ingress-controller
    version: 0.1.10
    values:
      - rbac:
          create: true
      - clusterName: base-prd
      - awsRegion: ap-northeast-1
      - awsVpcID: vpc-fb354b9c
      - podAnnotations:
          iam.amazonaws.com/role: alb-ingress-controller-role
      - image:
          tag: v1.1.2
  - name: prometheus-node-exporter
    namespace: monitoring
    chart: stable/prometheus-node-exporter
    version: 1.6.0
    values:
      - rbac:
          create: true
          pspEnabled: true
      - podLabels:
          prometheus.io/scrape: 'true'
          prometheus.io/port: '9100'
      - service:
          type: ClusterIP
          port: 9100
  - name: kube-state-metrics
    namespace: monitoring
    chart: stable/kube-state-metrics
    version: 2.3.1
    values:
      - rbac:
          create: true
      - service:
          port: 8080
      - podAnnotations:
          prometheus.io/scrape: 'true'
          prometheus.io/port: '8080'
  - name: kiam
    namespace: kube-system
    chart: uswitch/kiam
    version: 5.7.0
    values:
      - agent:
          host:
            iptables: true
            interface: "!eth0"
          extraHostPathMounts:
            - name: ssl-certs
              hostPath: /etc/ssl/certs
              mountPath: /etc/ssl/certs
              readOnly: true
      - server:
          assumeRoleArn: arn:aws:iam::564677439943:role/kiam-master-role
          nodeSelector:
            kubernetes.io/role: master
          # https://github.com/uswitch/kiam/blob/v3.3/deploy/server.yaml#L20-L24
          tolerations:
            - key: "node-role.kubernetes.io/master"
              effect: "NoSchedule"
              operator: "Exists"
          # https://github.com/uswitch/kiam/blob/v3.3/deploy/server.yaml#L28-L31
          sslCertHostPath: /etc/ssl/certs
  # - name: kms-secrets
  #   namespace: kube-system
  #   chart: h3poteto-stable/kms-secrets
  #   version: 0.1.2
  #   values:
  #     - rbac:
  #         create: true
  #     - podAnnotations:
  #         iam.amazonaws.com/role: kms-secrets-role
  # Note: Now I don't use metrics-server,
  # because it only use horizontal pod autoscale.
  # In monitoring, it is not useful, because it is not support prometheus endpoint.
  # - name: metrics-server
  #   namespace: kube-system
  #   chart: stable/metrics-server
  #   version: 2.5.1
  #   values:
  #     - rbac:
  #         create: true
  #         pspEnabled: true
  #     - serviceAccount:
  #         create: true
  #     - image:
  #         tag: v0.3.1
  #     - args: ["--kubelet-insecure-tls"]

